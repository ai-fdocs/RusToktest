name: Dependencies

on:
  schedule:
    - cron: "0 4 * * 1"
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    env:
      CARGO_HOME: ${{ github.workspace }}/.cargo
    steps:
      - uses: actions/checkout@v4
      - name: Clean cargo-deny advisory db cache
        run: |
          rm -rf "$CARGO_HOME/advisory-dbs" || true
          rm -rf "$CARGO_HOME"/advisory-db-empty-* || true
        shell: bash
      - uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check
          arguments: --all-features
          manifest-path: ./Cargo.toml
          log-level: warn

  outdated:
    name: Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked
      - name: Check root dependencies
        run: cargo outdated -R
